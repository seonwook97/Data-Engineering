# Presto(Trino)

1. [Presto의 이해](#1-presto의-이해)
2. [Presto Architecture](#2-presto-architecture)

---

## 1. Presto의 이해

### 1-1. Presto
- Presto 는 2013년에 Facebook 에서 opensource 로 공개한 PB 수준의 Hadoop 데이터에 대해서 SQL 쿼리가 가능한 분산 쿼리 엔진이다.
- Prestor가 있기 전 기존의 hive와 같은 시스템은 SQL을 Hadoop 에서 가능하게 했지만, 단일 머신 기반으로 동작하는 한계가 있었다. Presto는 대량의 데이터를 SQL로 조회하는데 있어서 확장성을 기반으로 더 빠르게 대량의 데이터에 대해 다양한 쿼리를 지원하기 위해 만들어졌다.
- Presto 의 활용도가 높아지면서 Hadoop 뿐만 아니라 여러 저장소를 Connector 라는 plugin 방식으로 연결해서 여러 데이터 시스템과의 연동을 SQL을 통해서 할 수 있도록 했다. 현재는 다양한 빅데이터 시스템의 쿼리 허브로도 쓰일 수 있게 되었다.
- 이는 Presto의 설계가 분산해서 데이터를 처리하는 아키텍처, query plan 과 execution model 의 추상화, 잘 설계된 connector 인터페이스를 통해서 가능했다.
- Presto 를 만들었던 주축 개발자들이 Facebook을 나와서 Trino 라는 프로젝트로 새롭게 개발하고 있다. 현재는 Presto 는 유지만 되고 있고, active 한 개발은 Trino 를 기준으로 되고 있다.

---

## 2. Presto Architecture

### 2-1. ServerTypes
- Presto는 하나의 coordinator와 여러개의 worker 서버가 클러스터를 이룬다.

<img width="500" alt="image" src="https://github.com/seonwook97/Data-Engineering/assets/92377162/bba6e68e-f152-493a-ad5a-214e6dc35697">

#### 2-1-1. Coordinator
- Coordinator 는 query 를 parsing, planning 하고, worker node 를 관리하는 역할을 한다. 설치 단계에서 Presto 의 brain 역할을 한다. 클라이언트는 coordinator 에게 statement를 제출한다.
- Presto Cluster 는 하나 이상의 worker 와 하나의 coordinator 가 있어야 한다. test 또는 dev 목적으로 사용한다면 하나의 노드로 coordinator, worker 역할을 모두 하게 할 수도 있다.
- coordinator 는 각 worker 의 활동을 트래킹하고 query 실행과 관련해서 로드를 조절한다. coordinator 는 query 를 실행하기 위한 logical 모델을 만든다. 이 logical 모델은 실행의 단위를 논리적으로 구분한 stage 들의 연결로 구성되어있다. 각 stage 는 실제 worker 에서 실행할 task 들로 구성되어있다.
- coordinator 는 worker 와 REST API로 통신한다.

#### 2-1-2. Worker
- Worker 는 task 실행하고 data 를 처리하는 서버이다. Worker 는 connector 로부터 데이터를 가져오고 중간 처리 데이터를 서로 교환한다. coordinator 는 worker 가 처리한 데이터를 가져와서 client 에게 리턴한다.
- Worker 는 시작할 때 cooridnator 의 discovery server 에게 자신을 등록해야 coordinator가 task 를 나눠줄 수 있다.
- Worker 는 다른 worker 들과 coordinator 사이에 REST API로 통신한다.

### 2-2. Data Sources
- Presto 는 여러 종류의 datasource 와 연결해서 presto sql 로 통합해서 조회할 수 있는 것이 장점이다. 다양한 데이터 소스와 연결하기 위한 data source 모델을 설명한다.

#### 2-2-1. Connector
- Connector는 Presto 와 Hive, RDBMS 등을 연결한다. database driver 와 비슷한 방식이라고 생각하면 쉽다. Connector 는 Presto’s SPI 의 구현체로서 datasource 가 달라지더라도 Presto 가 표준API 로 상호작용할 수 있도록 한다.
    - SPI : https://prestodb.io/docs/current/develop/spi-overview.html

- 기본 built-in connector
    - JMX : https://prestodb.io/docs/current/connector/jmx.html
    - Hive : https://prestodb.io/docs/current/connector/hive.html
    - TPCH : https://prestodb.io/docs/current/connector/tpch.html

- 모든 catalog 는 특별한 connector 와 연결되어있다. `connector.name` 으로 설정한 이름이 해당 connector 와 연결하는 catalog 의 이름이 된다. 같은 type 의 connector 라도 별도의 catalog로 두개 이상 접근하도록 설정할 수 있다. 예를 들어 hive cluster 가 두개라면 hive1, hive2 의 이름으로 catalog 로 만들 수 있다. 

- 이용 가능한 connectors
    - https://prestodb.io/docs/current/connector.html
    - https://trino.io/docs/current/connector.html

#### 2-2-2. Catalog
- Catalog는 schema와 connector의 datasource를 참조하고 있다.
- 예를 들어, JMX connector 를 통해서 JMX 정보에 접근하는 JMX catalog 를 설정할 수 있다. Presto 에 SQL 을 실행하면 하나 이상의 catalog 를 참고해서 데이터 소스에 접근한다.
- 새로운 table 을 Presto 에 만들때 catalog 의 root 부터 fully-qualified table name 을 사용한다.
- 예를 들어 `hive.test_data.test` 라는 table name 은 `hive` catalog 에 있는 `test_data` schema 의 `test` table 을 의미한다.
- catalog 들은 Presto config directory 의 properties 파일에 정의한다.